<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin & User Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background-color: #0d6efd;
            min-height: 100vh;
        }

        .tab-content {
            padding-top: 1rem;
        }

        /* Ensure sidebar pills look clickable */
        .sidebar .nav-pills .nav-link {
            cursor: pointer;
        }

        .sidebar .nav-link.active {
            color: #fff; /* White text */
            background-color: #0a58ca; /* Darker blue for active */
            font-weight: bold;
        }

        /* Hover effect for sidebar links */
        .sidebar .nav-link:not(.active):hover {
            color: #fff;
            background-color: #0b5ed7; /* Slightly darker blue on hover */
        }

        /* Adjust padding/margins if needed */
        main {
            padding-top: 1rem; /* Add some space below navbar */
        }

        body {
            background-color: #15142b;
            color: #adc1cd;
        }

        #editUserModal .modal-body .form-control,
        #editUserModal .modal-body .form-select {
            background-color: #495057; /* Example: light gray background */
            color: #f4f4f4; /* Ensure text is readable, default dark text */
        }

        #deleteUserModal .modal-body .form-control:disabled,
        #deleteUserModal .modal-body .form-select:disabled {
            background-color: #343a40;
            color: #e2e6ea;
            opacity: 0.75;
            cursor: not-allowed;
        }

        .nav-tabs .nav-link {
            color: #ffffff; /* Default text color (dark gray) */
            background-color: #395e88; /* Default background color (light gray) */
            border-color: #dee2e6 #dee2e6 #fff; /* Default border color (bottom border usually matches content) */
            margin-bottom: -1px; /* Prevents double border with content */
        }

        .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6; /* Change border on hover */
            background-color: #318bea; /* Slightly lighter gray on hover */
            color: #ffffff; /* Example: Blue text on hover */
        }

        /* Active tab button style */
        .nav-tabs .nav-link.active {
            color: #ffffff; /* Active text color */
            background-color: #2f68b6; /* Active background (usually white, matches content pane) */
            border-color: #dee2e6 #dee2e6 #fff; /* Active border (matches inactive, bottom matches content) */
            font-weight: bold; /* Make active text bold */
        }

        #newUserTabContent .form-control,
        #newUserTabContent .form-select {
            background-color: #495057; /* Example: slightly darker gray */
            color: #ced4da; /* Ensure text is readable */
            border-color: #adb5bd; /* Match border to background or make it slightly darker */
        }

        /* Optional: Style for when the New User input is focused */
        #newUserTabContent .form-control:focus,
        #newUserTabContent .form-select:focus {
            background-color: #343a40; /* Darker gray when focused */
            color: #adb5bd; /* Darker text */
            border-color: #6c757d; /* Darker border */
            box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.25); /* Custom shadow */
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Combined Panel</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item d-flex align-items-center"> <span class="navbar-text me-3">Username:
                        <span id="navbarUsername">Loading...</span> with roles: <span id="navbarRoles">Loading...</span> </span>
                </li>
                <li class="nav-item">
                    <form action="/logout" method="post">
                        <button type="submit" class="btn btn-outline-danger">Logout</button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div style="padding-top: 56px;">
    <div class="container-fluid">
        <div class="row">

            <div class="col-md-3 col-lg-2 px-0">
                <div class="d-flex flex-column flex-shrink-0 p-3 bg-dark sidebar">
                    <hr>
                    <ul class="nav nav-pills flex-column mb-auto" id="sidebarTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="admin-tab-link" data-bs-toggle="pill" href="#admin-view"
                               role="tab" aria-controls="admin-view" aria-selected="true">
                                Admin
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="user-tab-link" data-bs-toggle="pill" href="#user-view" role="tab"
                               aria-controls="user-view" aria-selected="false">
                                User
                            </a>
                        </li>
                    </ul>
                    <hr>
                </div>
            </div>

            <main class="col-md-9 col-lg-10 px-md-4">
                <div id="successMessage"
                     class="alert alert-success alert-dismissible fade show" role="alert" style="display: none;">
                    <span></span>
                    <button type="button" class="btn-close" aria-label="Close"></button>
                </div>
                <div id="errorMessage" class="alert alert-danger alert-dismissible fade show"
                     role="alert" style="display: none;">
                    <span></span>
                    <button type="button" class="btn-close" aria-label="Close"></button>
                </div>

                <div class="tab-content" id="sidebarTabsContent">

                    <div class="tab-pane fade show active" id="admin-view" role="tabpanel"
                         aria-labelledby="admin-tab-link">
                        <h1 class="mb-4">Admin panel</h1>

                        <ul class="nav nav-tabs" id="adminContentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="users-table-subtab" data-bs-toggle="tab"
                                        data-bs-target="#usersTableTabContent" type="button" role="tab"
                                        aria-controls="usersTableTabContent" aria-selected="true">Users table
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="new-user-subtab" data-bs-toggle="tab"
                                        data-bs-target="#newUserTabContent" type="button" role="tab"
                                        aria-controls="newUserTabContent" aria-selected="false">New User
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="adminContentTabsContent">
                            <div class="tab-pane fade show active" id="usersTableTabContent" role="tabpanel"
                                 aria-labelledby="users-table-subtab">
                                <div class="mt-3">
                                    <table class="table table-bordered table-striped table-dark">
                                        <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Age</th>
                                            <th>Email</th>
                                            <th>Username</th>
                                            <th>Roles</th>
                                            <th>Edit</th>
                                            <th>Delete</th>
                                        </tr>
                                        </thead>
                                        <tbody id="userTableBody">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="alert alert-info mt-3" id="noUsersMessage" style="display: none;">
                                    No users found.
                                </div>
                            </div>

                            <div class="tab-pane fade" id="newUserTabContent" role="tabpanel"
                                 aria-labelledby="new-user-subtab">
                                <div class="container py-4">
                                    <h2>Add New User</h2>
                                    <form id="newUserForm" method="POST">
                                        <div class="mb-3">
                                            <label for="newName" class="form-label">Name</label>
                                            <input type="text" name="name" id="newName" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newEmail" class="form-label">Email</label>
                                            <input type="email" name="email" id="newEmail" class="form-control"
                                                   required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newAge" class="form-label">Age</label>
                                            <input type="number" name="age" id="newAge" class="form-control" min="0">
                                        </div>
                                        <div class="mb-3">
                                            <label for="newUsername" class="form-label">Username</label>
                                            <input type="text" name="username" id="newUsername"
                                                   class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">Password</label>
                                            <input type="password" name="password" id="newPassword"
                                                   class="form-control" required></div>
                                        <div class="mb-3">
                                            <label for="newRoles" class="form-label">Roles</label>
                                            <select multiple name="roles" id="newRoles" class="form-select" required>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-success">Add User</button>
                                    </form>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="tab-pane fade" id="user-view" role="tabpanel" aria-labelledby="user-tab-link">
                        <h1 class="mb-4">User Information</h1>
                        <div><h2>Welcome, <span id="userInfoName">Loading...</span>!</h2>
                            <table class="table table-bordered table-striped table-dark">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Age</th>
                                    <th>Email</th>
                                    <th>Username</th>
                                    <th>Roles</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td id="userInfoId">Loading...</td>
                                    <td id="userInfoDisplayName">Loading...</td>
                                    <td id="userInfoAge">Loading...</td>
                                    <td id="userInfoEmail">Loading...</td>
                                    <td id="userInfoUsername">Loading...</td>
                                    <td id="userInfoRoles">Loading...</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="userInfoNotAvailable" class="alert alert-warning" style="display: none;">
                            User details not available.
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

</div>
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editUserForm" method="post">
                <div class="modal-body">
                    <input type="hidden" id="editUserId" name="id">

                    <div class="mb-3">
                        <label for="editName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAge" class="form-label">Age</label>
                        <input type="number" class="form-control" id="editAge" name="age" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="editPassword" name="password">
                    </div>
                    <div class="mb-3">
                        <label for="editRoles" class="form-label">Roles</label>
                        <select multiple class="form-select" id="editRoles" name="roles" required>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                <button type="button" class="btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="deleteUserForm" method="post">
                <div class="modal-body">
                    <p>Are you sure you want to delete user <strong id="deleteUserName"></strong>
                        with username: <strong id="deleteUserUsername"></strong>?</p>

                    <input type="hidden" id="deleteUserId" name="id">
                    <div class="mb-3">
                        <label for="deleteNameDisplay" class="form-label">Name</label>
                        <input type="text" class="form-control" id="deleteNameDisplay" disabled></div>
                    <div class="mb-3">
                        <label for="deleteAgeDisplay" class="form-label">Age</label>
                        <input type="number" class="form-control" id="deleteAgeDisplay" disabled></div>
                    <div class="mb-3">
                        <label for="deleteEmailDisplay" class="form-label">Email</label>
                        <input type="email" class="form-control" id="deleteEmailDisplay" disabled></div>
                    <div class="mb-3">
                        <label for="deleteUsernameDisplay" class="form-label">Username</label>
                        <input type="text" class="form-control" id="deleteUsernameDisplay" disabled></div>
                    <div class="mb-3">
                        <label for="deleteRolesDisplay" class="form-label">Roles</label>
                        <select multiple class="form-select" id="deleteRolesDisplay" disabled>
                        </select>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- Helper Functions ---

    // Function to display alert messages
    function displayMessage(type, message) {
        const successAlert = document.getElementById('successMessage');
        const errorAlert = document.getElementById('errorMessage');

        // Hide existing alerts and remove 'show' class
        if (successAlert) {
            successAlert.style.display = 'none';
            successAlert.classList.remove('show'); // Ensure it's not showing before displaying new
        }
        if (errorAlert) {
            errorAlert.style.display = 'none';
            errorAlert.classList.remove('show'); // Ensure it's not showing before displaying new
        }

        let alertDiv;
        if (type === 'success' && successAlert) {
            alertDiv = successAlert;
            alertDiv.querySelector('span').textContent = message;
            alertDiv.classList.remove('alert-danger');
            alertDiv.classList.add('alert-success');
        } else if (type === 'error' && errorAlert) {
            alertDiv = errorAlert;
            alertDiv.querySelector('span').textContent = message;
            alertDiv.classList.remove('alert-success');
            alertDiv.classList.add('alert-danger');
        }

        if (alertDiv) {
            alertDiv.style.display = 'block'; // Set display first
            alertDiv.classList.add('show'); // <-- ADD THIS LINE to make it visible via CSS transition/rule
        } else {
            // Fallback if alert divs are not found
            alert(type.toUpperCase() + ': ' + message);
            console.log('Attempted to display message, but alert container not found:', message);
        }
    }

    // Function to collect form data into a JSON object
    function serializeFormToJSON(form) {
        const obj = {};
        const formData = new FormData(form);

        // Iterate over form data entries
        for (const [name, value] of formData.entries()) {
            // Handle multiple values for the same name (e.g., multi-select roles)
            if (obj[name]) {
                if (!Array.isArray(obj[name])) {
                    obj[name] = [obj[name]];
                }
                obj[name].push(value);
            } else {
                obj[name] = value;
            }
        }

        // Manually handle the roles select to get an array of IDs
        const rolesSelect = form.querySelector('select[name="roles"]');
        if (rolesSelect) {
            // Assuming roles have an 'id' property
            obj.roles = Array.from(rolesSelect.selectedOptions)
                .map(option => ({id: parseInt(option.value)})); // Replace the simple array of IDs with array of objects {id: ...}
        }

        // Ensure numeric fields are numbers, not strings
        if (obj.id) obj.id = parseInt(obj.id);
        if (obj.age) obj.age = parseInt(obj.age);

        return obj;
    }

    // Function to render a single user row
    function renderUserRow(user) {
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.name}</td>
            <td>${user.age}</td>
            <td>${user.email}</td>
            <td>${user.username}</td>
            <td>${user.roles.map(role => role.name).join(', ')}</td>
            <td>
                <button type="button" class="btn btn-info btn-sm edit-user-button"
                        data-bs-toggle="modal" data-bs-target="#editUserModal"
                        data-user-id="${user.id}"
                        data-user-name="${user.name}"
                        data-user-age="${user.age}"
                        data-user-email="${user.email}"
                        data-user-username="${user.username}"
                        data-user-roles="${user.roles.map(role => role.id).join(',')}"
                        >
                    Edit
                </button>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm delete-user-button"
                        data-bs-toggle="modal" data-bs-target="#deleteUserModal"
                        data-user-id="${user.id}"
                        data-user-name="${user.name}"
                        data-user-username="${user.username}"
                        data-user-age="${user.age}"
                        data-user-email="${user.email}"
                        data-user-roles="${user.roles.map(role => role.id).join(',')}"
                        >
                    Delete
                </button>
            </td>
        `;
        // Note: Using innerHTML is simpler for rendering rows but be cautious with untrusted data.
        // For internal admin panel, it's generally acceptable.
        // Alternative: use document.createElement and appendChild for each td/button.
        return row;
    }

    // Function to fetch and display users (Updated to use renderUserRow)
    function fetchAndDisplayUsers() {
        const userTableBody = document.getElementById('userTableBody');
        const noUsersMessage = document.getElementById('noUsersMessage');

        userTableBody.innerHTML = ''; // Clear existing rows
        noUsersMessage.style.display = 'none'; // Hide empty message

        fetch('/api/users')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(users => {
                if (users.length === 0) {
                    noUsersMessage.style.display = 'block';
                } else {
                    users.forEach(user => {
                        const row = renderUserRow(user); // Use the helper to create the row
                        userTableBody.appendChild(row); // Append the row
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching users:', error);
                displayMessage('error', 'Failed to load users. Please check the server logs.'); // Use helper
            });
    }

    // Function to fetch and populate roles select dropdowns
    function fetchAndPopulateRoles(selectElementId, selectedRoleIds = []) {
        const selectElement = document.getElementById(selectElementId);
        if (!selectElement) return Promise.resolve(); // Return resolved promise if element not found

        // Clear existing options
        selectElement.innerHTML = '';
        selectElement.disabled = true; // Disable while loading

        return fetch('/api/users/roles') // Use the new endpoint to get roles
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // Parse the JSON data
            })
            .then(roles => {
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.name;
                    if (selectedRoleIds.includes(role.id)) {
                        option.selected = true; // Select roles if provided
                    }
                    selectElement.appendChild(option);
                });
                // Only re-enable the select if it's NOT the delete modal's roles display
                if (selectElementId !== 'deleteRolesDisplay') { // <-- ADD THIS CONDITIONAL CHECK
                    selectElement.disabled = false; // Enable after loading (only if not the delete modal)
                }
            })
            .catch(error => {
                console.error('Error fetching roles:', error);
                displayMessage('error', 'Failed to load roles.'); // Use helper
                selectElement.innerHTML = '<option value="">Error loading roles</option>';
                selectElement.disabled = true;
                return Promise.reject(error); // Propagate error
            });
    }

    // MODIFIED fetchAndDisplayCurrentUser to return the promise resolving with the user
    function fetchCurrentUser() {
        return fetch('/api/admin/me')
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 401 || response.status === 403) {
                    console.warn('User not authenticated for /api/admin/me. Redirecting to login.');
                    window.location.href = '/login?expired';
                    return Promise.reject('Not authenticated');
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            });
    }

    // This function will be called when the User tab is clicked
    function displayUserInfo(user) {
        const userInfoNameSpan = document.getElementById('userInfoName');
        const userInfoIdTd = document.getElementById('userInfoId');
        const userInfoDisplayNameTd = document.getElementById('userInfoDisplayName');
        const userInfoAgeTd = document.getElementById('userInfoAge');
        const userInfoEmailTd = document.getElementById('userInfoEmail');
        const userInfoUsernameTd = document.getElementById('userInfoUsername');
        const userInfoRolesTd = document.getElementById('userInfoRoles');
        const userInfoNotAvailableDiv = document.getElementById('userInfoNotAvailable');
        const userInfoContentDiv = document.querySelector('#user-view > div:not(#userInfoNotAvailable)'); // Select the div containing the table
        // Populate the HTML elements with the user data
        if (userInfoNameSpan) userInfoNameSpan.textContent = user.name; // Use name for welcome
        if (userInfoIdTd) userInfoIdTd.textContent = user.id;
        if (userInfoDisplayNameTd) userInfoDisplayNameTd.textContent = user.name; // Use name for table display
        if (userInfoAgeTd) userInfoAgeTd.textContent = user.age;
        if (userInfoEmailTd) userInfoEmailTd.textContent = user.email;
        if (userInfoUsernameTd) userInfoUsernameTd.textContent = user.username;
        if (userInfoRolesTd) userInfoRolesTd.textContent = user.roles.map(role => role.name).join(', '); // Assuming roles have names

        // Show the user info content
        if (userInfoContentDiv) userInfoContentDiv.style.display = 'block';
    }

    // Now, let's wire this up to the tab click event
    const userTabLink = document.getElementById('user-tab-link');
    if (userTabLink) {
        userTabLink.addEventListener('shown.bs.tab', () => { // Use Bootstrap's 'shown.bs.tab' event
            // Call the fetch function and then display the info
            fetchCurrentUser()
                .then(user => {
                    // On success, display the user info
                    displayUserInfo(user); // Display the data
                    // Also hide the 'not available' message if it was shown previously
                    const userInfoNotAvailableDiv = document.getElementById('userInfoNotAvailable'); // Get reference here
                    if (userInfoNotAvailableDiv) {
                        userInfoNotAvailableDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching or displaying user info:', error);
                    // Get the reference to the 'not available' div inside the catch block
                    const userInfoNotAvailableDiv = document.getElementById('userInfoNotAvailable');
                    // Get the reference to the content div to hide it
                    const userInfoContentDiv = document.querySelector('#user-view > div:not(#userInfoNotAvailable)');

                    if (userInfoNotAvailableDiv) {
                        userInfoNotAvailableDiv.style.display = 'block'; // Show 'not available' message
                    }
                    if (userInfoContentDiv) {
                        userInfoContentDiv.style.display = 'none'; // Hide content if showing error
                    }
                });
        });
    }
    // Initial fetch for the navbar (still needed when page loads)
    fetchCurrentUser()
        .then(user => {
            const navbarUsernameSpan = document.getElementById('navbarUsername');
            const navbarRolesSpan = document.getElementById('navbarRoles');
            if (navbarUsernameSpan) navbarUsernameSpan.textContent = user.username;
            if (navbarRolesSpan) navbarRolesSpan.textContent = user.roles.map(role => role.name).join(', ');
        })
        .catch(error => {
            console.error('Error fetching user for navbar:', error);
            const navbarUsernameSpan = document.getElementById('navbarUsername');
            const navbarRolesSpan = document.getElementById('navbarRoles');
            if (navbarUsernameSpan) navbarUsernameSpan.textContent = 'Error';
            if (navbarRolesSpan) navbarRolesSpan.textContent = 'Error';
        });

    // --- Event Listeners ---

    // Event listener for the New User form submission
    const newUserForm = document.getElementById('newUserForm');
    if (newUserForm) {
        newUserForm.addEventListener('submit', function (event) {
            event.preventDefault();
            const userData = serializeFormToJSON(newUserForm);

            const headers = {
                'Content-Type': 'application/json',
            };

            fetch('/api/users', {
                method: 'POST',
                headers: headers, // Use the headers object
                body: JSON.stringify(userData)
            })
                .then(async response => { // Use async to await response.json() later if needed
                    if (response.ok) { // Check for success status codes (2xx)
                        return response.json(); // Parse the response body (the created user)
                    } else {
                        // Handle error responses (e.g., 409 Conflict, 400 Bad Request)
                        const errorBody = await response.text(); // Get error message from body
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorBody}`);
                    }
                })
                .then(createdUser => {
                    displayMessage('success', 'User added successfully!'); // Display success message
                    newUserForm.reset(); // Clear the form
                    fetchAndDisplayUsers(); // Refresh the user table
                })
                .catch(error => {
                    console.error('Error adding user:', error);
                    // Display error message (e.g., "Username already exists.")
                    displayMessage('error', 'Error adding user: ' + error.message);
                });
        });
    }

    // Event listener for the Edit User form submission (in the modal)
    const editUserForm = document.getElementById('editUserForm');
    if (editUserForm) {
        editUserForm.addEventListener('submit', function (event) {
            event.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const userData = serializeFormToJSON(editUserForm);

            const headers = {
                'Content-Type': 'application/json',
            };

            fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: headers, // Use the headers object
                body: JSON.stringify(userData)
            })
                .then(async response => {
                    if (response.ok) { // Check for success status codes (2xx)
                        return response.json(); // Parse the response body (the updated user)
                    } else {
                        const errorBody = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorBody}`);
                    }
                })
                .then(updatedUser => {
                    displayMessage('success', 'User updated successfully!');
                    const modal = bootstrap.Modal.getInstance(editUserModal);
                    if (modal) modal.hide(); // Close the modal
                    fetchAndDisplayUsers(); // Refresh the user table
                })
                .catch(error => {
                    console.error('Error updating user:', error);
                    displayMessage('error', 'Error updating user: ' + error.message);
                    // Optionally keep modal open and display error inside it
                });
        });
    }

    // Event listener for the Delete User form submission (in the modal)
    const deleteUserForm = document.getElementById('deleteUserForm');
    if (deleteUserForm) {
        deleteUserForm.addEventListener('submit', function (event) {
            event.preventDefault();
            const userId = document.getElementById('deleteUserId').value;

            const headers = {}; // No Content-Type needed for DELETE typically

            fetch(`/api/users/${userId}`, {
                method: 'DELETE',
                headers: headers // Use the headers object
                // DELETE typically does not have a request body
            })
                .then(async response => {
                    if (response.ok) { // Check for success status codes (2xx, including 204 No Content)
                        // No response body expected for 204 No Content
                        return null; // Return null or handle based on expected API response
                    } else {
                        const errorBody = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorBody}`);
                    }
                })
                .then(() => { // .then() after response.ok handles success
                    displayMessage('success', 'User deleted successfully!');
                    const modal = bootstrap.Modal.getInstance(deleteUserModal);
                    if (modal) modal.hide(); // Close the modal
                    fetchAndDisplayUsers(); // Refresh the user table
                })
                .catch(error => {
                    console.error('Error deleting user:', error);
                    displayMessage('error', 'Error deleting user: ' + error.message);
                    // Optionally keep modal open and display error inside it
                });
        });
    }
    // --- Existing Modal JavaScript (Updated to use fetchAndPopulateRoles) ---

    var editUserModal = document.getElementById('editUserModal');
    var deleteUserModal = document.getElementById('deleteUserModal');

    // Handle Edit User Modal
    if (editUserModal) { // Ensure modal exists
        editUserModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var userId = button.getAttribute('data-user-id');

            var modalTitle = editUserModal.querySelector('.modal-title');
            var modalUserIdInput = editUserModal.querySelector('#editUserId');
            var modalNameInput = editUserModal.querySelector('#editName');
            var modalAgeInput = editUserModal.querySelector('#editAge');
            var modalEmailInput = editUserModal.querySelector('#editEmail');
            var modalUsernameInput = editUserModal.querySelector('#editUsername');
            var modalPasswordInput = editUserModal.querySelector('#editPassword');
            var modalRolesSelect = editUserModal.querySelector('#editRoles');

            modalPasswordInput.value = ''; // Always clear password on open
            modalTitle.textContent = 'Edit User: Loading...'; // Show loading state
            modalUserIdInput.value = userId;

            // Fetch the specific user's data from the API
            fetch(`/api/users/${userId}`)
                .then(response => {
                    if (!response.ok) {
                        // If user not found (404) or other error
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(user => {
                    modalTitle.textContent = 'Edit User: ' + user.name;
                    modalNameInput.value = user.name;
                    modalAgeInput.value = user.age;
                    modalEmailInput.value = user.email;
                    modalUsernameInput.value = user.username;

                    // Get user's role IDs from the fetched user object
                    const userRoleIds = user.roles.map(role => role.id);

                    // Fetch all roles and then select the user's roles
                    fetchAndPopulateRoles('editRoles', userRoleIds) // Pass userRoleIds
                        .catch(() => {
                            // Handle error during role population if needed
                            console.error("Failed to populate roles for edit modal.");
                        });

                })
                .catch(error => {
                    console.error('Error fetching user for edit modal:', error);
                    modalTitle.textContent = 'Edit User: Error';
                    displayMessage('error', 'Failed to load user data for editing.'); // Show main alert
                    const modal = bootstrap.Modal.getInstance(editUserModal);
                    if (modal) modal.hide(); // Close modal on error
                });
        });
    }

    // Handle Delete User Modal
    if (deleteUserModal) { // Ensure modal exists
        deleteUserModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var userId = button.getAttribute('data-user-id');

            // Fetch user details by ID to populate display fields accurately
            fetch(`/api/users/${userId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(user => {
                    // Update confirmation text
                    var modalUserNameStrong = deleteUserModal.querySelector('#deleteUserName');
                    var modalUserUsernameStrong = deleteUserModal.querySelector('#deleteUserUsername');
                    modalUserNameStrong.textContent = user.name;
                    modalUserUsernameStrong.textContent = user.username;

                    // Set hidden ID for deletion form
                    var modalUserIdInput = deleteUserModal.querySelector('#deleteUserId');
                    modalUserIdInput.value = userId;

                    // Populate display input elements
                    deleteUserModal.querySelector('#deleteNameDisplay').value = user.name;
                    deleteUserModal.querySelector('#deleteAgeDisplay').value = user.age;
                    deleteUserModal.querySelector('#deleteEmailDisplay').value = user.email;
                    deleteUserModal.querySelector('#deleteUsernameDisplay').value = user.username;

                    // Populate delete modal roles display
                    const userRoleIds = user.roles.map(role => role.id);
                    fetchAndPopulateRoles('deleteRolesDisplay', userRoleIds) // Pass userRoleIds
                        .catch(() => {
                            console.error("Failed to populate roles for delete modal.");
                        });

                })
                .catch(error => {
                    console.error('Error fetching user for delete modal:', error);
                    displayMessage('error', 'Failed to load user data for deletion.'); // Show main alert
                    const modal = bootstrap.Modal.getInstance(deleteUserModal);
                    if (modal) modal.hide(); // Close modal on error
                });
        });
    }

    // --- Delegation for Edit/Delete Buttons (Since table rows are added dynamically) ---

    const userTableBody = document.getElementById('userTableBody');
    if (userTableBody) { // Ensure tbody exists
        userTableBody.addEventListener('click', function (event) {
            const target = event.target;

            // Check if the clicked element is an Edit button
            if (target.classList.contains('edit-user-button')) {
                // Trigger Bootstrap modal show event manually if needed,
                // but data-bs-toggle should handle this. We just need the listener above.
                // Make sure the modal listener is attached correctly.
            }

            // Check if the clicked element is a Delete button
            if (target.classList.contains('delete-user-button')) {
                // Trigger Bootstrap modal show event manually if needed,
                // but data-bs-toggle should handle this. We just need the listener above.
                // Make sure the modal listener is attached correctly.
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Get references to the alert elements
        const successAlert = document.getElementById('successMessage');
        const errorAlert = document.getElementById('errorMessage');

        // 2. Find the close buttons within these alerts
        const successCloseButton = successAlert ? successAlert.querySelector('.btn-close') : null;
        const errorCloseButton = errorAlert ? errorAlert.querySelector('.btn-close') : null;

        // 3. Add click listeners to the close buttons to manually hide alerts
        if (successCloseButton && successAlert) {
            successCloseButton.addEventListener('click', () => {
                successAlert.style.display = 'none';
                successAlert.classList.remove('show'); // Manage fade
            });
        }
        if (errorCloseButton && errorAlert) {
            errorCloseButton.addEventListener('click', () => {
                errorAlert.style.display = 'none';
                errorAlert.classList.remove('show'); // Manage fade
            });
        }

        // 4. Initial check for Thymeleaf rendered messages and set display
        // This logic now uses the textContent of the hidden divs
        if (successAlert && successAlert.textContent.trim() !== '') {
            successAlert.style.display = 'block';
            successAlert.classList.add('show'); // Trigger fade-in
        } else if (successAlert) {
            successAlert.style.display = 'none';
            successAlert.classList.remove('show'); // Ensure hidden
        }

        if (errorAlert && errorAlert.textContent.trim() !== '') {
            errorAlert.style.display = 'block';
            errorAlert.classList.add('show'); // Trigger fade-in
        } else if (errorAlert) {
            errorAlert.style.display = 'none';
            errorAlert.classList.remove('show'); // Ensure hidden
        }
        // 5. Trigger the initial data fetch and roles population
        fetchAndDisplayUsers(); // Populate the user table
        fetchAndPopulateRoles('newRoles'); // Populate roles for the "New User" form
        // Note: Roles for Edit/Delete modals are populated when the modal is shown
    });

</script>
</body>
</html>